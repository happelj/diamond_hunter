<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Diamond Hunter</title>
  <style>
    body { margin: 0; overflow: hidden; }
    #overlay { position: absolute; top: 10px; left: 10px; color: #fff; font-family: sans-serif; z-index: 1; }
    #startButton { position: absolute; top: 50%; width: 100%; text-align: center; color: #fff; font-family: sans-serif; cursor: pointer; }
  </style>

  <!-- Import map for Three.js ES modules -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.module.js",
      "three/": "https://cdn.jsdelivr.net/npm/three@0.152.0/"
    }
  }
  </script>
</head>
<body>
  <div id="overlay" style="display:none;">Diamonds: <span id="score">0</span>/100</div>
  <div id="startButton">Click to Start</div>

  <script type="module">
    import * as THREE from 'three';
    import { PointerLockControls } from 'three/examples/jsm/controls/PointerLockControls.js';

    let camera, scene, renderer, controls;
    const diamonds = [];
    const monsters = [];
    let score = 0;
    let won = false;

    const scoreEl = document.getElementById('score');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startButton');

    init();
    function init() {
      // Camera and scene
      camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 1, 2000);
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x87ceeb);
      scene.fog = new THREE.Fog(0x87ceeb, 0, 750);

      // Lights
      const hemi = new THREE.HemisphereLight(0xffffff, 0x444444);
      hemi.position.set(0, 200, 0);
      scene.add(hemi);
      const dir = new THREE.DirectionalLight(0xffffff);
      dir.position.set(0, 200, 100);
      scene.add(dir);

      // Controls
      controls = new PointerLockControls(camera, document.body);
      startBtn.addEventListener('click', () => controls.lock());
      controls.addEventListener('lock', () => { startBtn.style.display = 'none'; overlay.style.display = 'block'; });
      controls.addEventListener('unlock', () => { overlay.style.display = 'none'; startBtn.style.display = 'block'; });
      scene.add(controls.getObject());
      // Start player above ground
      controls.getObject().position.set(0, 10, 0);

      // Floor
      const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(2000, 2000, 100, 100).rotateX(-Math.PI/2),
        new THREE.MeshPhongMaterial({ color: 0x228B22 })
      );
      scene.add(floor);

      // Trees
      for (let i = 0; i < 50; i++) {
        const trunk = new THREE.Mesh(
          new THREE.CylinderGeometry(1, 1, 10, 8),
          new THREE.MeshPhongMaterial({ color: 0x8b4513 })
        );
        trunk.position.set(Math.random() * 1000 - 500, 5, Math.random() * 1000 - 500);
        scene.add(trunk);
        const leaves = new THREE.Mesh(
          new THREE.SphereGeometry(5, 8, 8),
          new THREE.MeshPhongMaterial({ color: 0x006400 })
        );
        leaves.position.set(trunk.position.x, trunk.position.y + 7, trunk.position.z);
        scene.add(leaves);
      }

      // Mountains (upright cones)
      for (let i = 0; i < 8; i++) {
        const angle = (Math.PI * 2 / 8) * i;
        const radius = 800 + Math.random() * 200;
        const x = Math.cos(angle) * radius;
        const z = Math.sin(angle) * radius;
        const mountain = new THREE.Mesh(
          new THREE.ConeGeometry(200, 400, 16),
          new THREE.MeshPhongMaterial({ color: 0x555555 })
        );
        // Position so base sits on ground (half the cone height)
        mountain.position.set(x, 200, z);
        scene.add(mountain);
      }

      // Clouds
      for (let i = 0; i < 20; i++) {
        const cloud = new THREE.Group();
        for (let j = 0; j < 5; j++) {
          const c = new THREE.Mesh(
            new THREE.SphereGeometry(20, 8, 8),
            new THREE.MeshPhongMaterial({ color: 0xffffff, transparent: true, opacity: 0.8 })
          );
          c.position.set(Math.random() * 40 - 20, Math.random() * 10, Math.random() * 40 - 20);
          cloud.add(c);
        }
        cloud.position.set(Math.random() * 1600 - 800, 200 + Math.random() * 100, Math.random() * 1600 - 800);
        scene.add(cloud);
      }

      // Diamonds
      const dGeo = new THREE.OctahedronGeometry(5);
      const dMat = new THREE.MeshPhongMaterial({ color: 0x00ffff });
      for (let i = 0; i < 100; i++) {
        const d = new THREE.Mesh(dGeo, dMat);
        d.position.set(Math.random() * 1000 - 500, 5, Math.random() * 1000 - 500);
        scene.add(d);
        diamonds.push(d);
      }

      // Monsters
      const mGeo = new THREE.BoxGeometry(10, 20, 10);
      const mMat = new THREE.MeshPhongMaterial({ color: 0xff0000 });
      for (let i = 0; i < 10; i++) {
        const m = new THREE.Mesh(mGeo, mMat);
        m.position.set(Math.random() * 1000 - 500, 10, Math.random() * 1000 - 500);
        scene.add(m);
        monsters.push(m);
      }

      // Renderer
      renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // Input events
      window.addEventListener('resize', onResize);
      document.addEventListener('keydown', onKey);
      document.addEventListener('keyup', onKey);

      animate();
    }

    function onResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    const keys = {};
    function onKey(e) { keys[e.code] = e.type === 'keydown'; }

    function animate() {
      requestAnimationFrame(animate);
      if (controls.isLocked) {
        // Keep constant height
        controls.getObject().position.y = 10;

        // Move player
        const delta = 0.1;
        const dir = new THREE.Vector3(
          (keys['KeyD'] ? 1 : 0) - (keys['KeyA'] ? 1 : 0),
          0,
          (keys['KeyS'] ? 1 : 0) - (keys['KeyW'] ? 1 : 0)
        ).normalize();
        if (dir.length()) {
          const vel = dir.multiplyScalar(400 * delta);
          controls.getObject().translateX(vel.x * delta);
          controls.getObject().translateZ(vel.z * delta);
        }

        // Collect diamonds
        const pos = controls.getObject().position;
        diamonds.forEach((d, i) => {
          if (d && d.position.distanceTo(pos) < 10) {
            scene.remove(d);
            diamonds[i] = null;
            scoreEl.textContent = ++score;
            if (score >= 100 && !won) { won = true; overlay.textContent = 'You Win!'; }
          }
        });

        // Monster AI: chase player
        monsters.forEach(m => {
          const v = new THREE.Vector3().subVectors(pos, m.position).normalize();
          m.position.add(v.multiplyScalar(0.5));
        });

        // Separate overlapping monsters
        const sepDist = 20;
        monsters.forEach((a, i) => {
          monsters.forEach((b, j) => {
            if (i >= j) return;
            const dist = a.position.distanceTo(b.position);
            if (dist < sepDist) {
              const overlap = sepDist - dist;
              const push = a.position.clone().sub(b.position).normalize().multiplyScalar(overlap * 0.5);
              a.position.add(push);
              b.position.sub(push);
            }
          });
        });

        // Check collisions
        monsters.forEach(m => {
          if (m.position.distanceTo(pos) < 10 && !won) {
            overlay.textContent = 'Game Over';
            controls.unlock();
          }
        });
      }
      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
